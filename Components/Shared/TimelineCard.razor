@using ChronoRead.Models
@using System.Globalization

@{
    ChronoNote noteToRender = null;
    NoteStack stack = null;

    if (Item is ChronoNote note)
    {
        noteToRender = note;
    }
    else if (Item is NoteStack noteStack)
    {
        stack = noteStack;
        noteToRender = stack.TopNote;
    }
}

@if (noteToRender != null)
{
    <span class="@Item.MarkerCssClass"
          data-controls="@Item.Id"
          data-anchor="@noteToRender.AnchorParagraphId"
          data-precise-top="@(Item.VerticalPosition.ToString(CultureInfo.InvariantCulture))"
          title="@(Item.Type == NoteType.Ai ? "AI 思考" : "我的感悟")"
          @onclick="ToggleVisibility">

        @if (stack != null)
        {
            @stack.Notes.Count
        }
        else
        {
            <span>1</span>
        }
    </span>

    <div class="@Item.CssClass"
         id="@Item.Id"
         data-anchor="@noteToRender.AnchorParagraphId"
         data-precise-top="@(Item.VerticalPosition.ToString(CultureInfo.InvariantCulture))">

        <div class="card-summary" @onclick="ToggleExpansion">
            <blockquote>@noteToRender.Quote</blockquote>
            <p>@noteToRender.SummaryText</p>
        </div>

        <div class="card-expansion">
            <div class="chat-history">
                @foreach (var msg in noteToRender.Messages)
                {
                    <div class="@msg.CssClass">@msg.Text</div>
                }
            </div>
            <div class="chat-input-wrapper">
                <div class="ask-input">
                    <input type="text" placeholder="@(noteToRender.Type == NoteType.Ai ? "回复 AI..." : "继续思考...")">
                    <button>发送</button>
                </div>
            </div>
        </div>

        @if (stack != null && stack.Notes.Count > 1)
        {
            <div class="stack-scroll-hint">
                (滚轮切换 @stack.Notes.IndexOf(noteToRender) + 1 / @stack.Notes.Count)
            </div>
        }
    </div>
}


@code {
    [Parameter]
    public ITimelineItem Item { get; set; }

    [Parameter]
    public EventCallback<ITimelineItem> OnToggleExpansion { get; set; }

    [Parameter]
    public EventCallback<ITimelineItem> OnToggleVisibility { get; set; }

    private async Task ToggleExpansion()
    {
        Item.IsExpanded = !Item.IsExpanded;
        await OnToggleExpansion.InvokeAsync(Item);
    }

    private async Task ToggleVisibility()
    {
        Item.IsVisible = !Item.IsVisible;
        await OnToggleVisibility.InvokeAsync(Item);
    }
}